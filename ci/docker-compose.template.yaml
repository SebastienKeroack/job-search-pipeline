name: job-search-pipeline

services:
  n8n:
    container_name: n8n
    image: n8n-patched:latest
    environment:
    # timezone
    - TZ=EST
    - GENERIC_TIMEZONE=EST
    - N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS=true

    # timeouts (seconds)
    - EXECUTIONS_TIMEOUT=86400
    - N8N_RUNNERS_TASK_TIMEOUT=120
    - N8N_RUNNERS_TASK_REQUEST_TIMEOUT=360
    # timeouts (milliseconds)
    - N8N_HTTP_REQUEST_TIMEOUT=86400000
    - N8N_HTTP_HEADERS_TIMEOUT=120000
    - N8N_HTTP_KEEPALIVE_TIMEOUT=65000
    - FETCH_HEADERS_TIMEOUT=1800000
    - FETCH_BODY_TIMEOUT=12000000
    - FETCH_CONNECT_TIMEOUT=600000
    - FETCH_KEEPALIVE_TIMEOUT=65000

    # node runtime / patch
    - NODE_PATH=/opt/extra/node_modules
    - NODE_OPTIONS=--require=/home/node/.n8n/patch-http-timeouts.js

    # runners
    - N8N_RUNNERS_ENABLED=true
    - N8N_RUNNERS_MODE=external
    - N8N_RUNNERS_BROKER_LISTEN_ADDRESS=0.0.0.0
    - N8N_RUNNERS_AUTH_TOKEN=$N8N_RUNNERS_AUTH_TOKEN
    - N8N_PORT=$N8N_PORT
    - WEBHOOK_URL=http://localhost:$N8N_PORT

    # python runner
    - N8N_NATIVE_PYTHON_RUNNER=true
    volumes:
    - "$N8N_HOME:/home/node/.n8n"
    - "$CANDIDATE_ROOT:/home/node/.n8n-files/candidate"
    ports:
    - "$N8N_PORT:$N8N_PORT"
    networks:
    - job-search-pipeline-net

  task-runners:
    container_name: n8n-runners
    image: n8n-task-runners:latest
    environment:
    # timeouts (seconds)
    - N8N_RUNNERS_TASK_TIMEOUT=120

    # runners
    - N8N_RUNNERS_TASK_BROKER_URI=http://n8n:5679
    - N8N_RUNNERS_AUTO_SHUTDOWN_TIMEOUT=0
    - N8N_RUNNERS_AUTH_TOKEN=$N8N_RUNNERS_AUTH_TOKEN
    volumes:
    - "$JOBSPY_ROOT:/home/runner/third_party/JobSpy"
    - "$CANDIDATE_ROOT:/home/runner/candidate"
    ports:
    - "5679:5679"
    networks:
    - job-search-pipeline-net

networks:
  job-search-pipeline-net:
    name: job-search-pipeline-net
